name: Deploy Web Server

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24' # Match your dev environment

      - name: Install and Build
        working-directory: ./frontend
        run: |
          npm install
          npm run build
          
      - name: Pre-Deploy (Clean and Prep)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Remove old files so SCP has a clean, empty directory to write to
            sudo rm -rf /opt/bitnami/apache/htdocs/*
            # Ensure the folder itself is owned by you for the transfer
            sudo chown bitnami:bitnami /opt/bitnami/apache/htdocs

      - name: Deploy to Bitnami via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # Path to your build output (e.g., frontend/dist or frontend/build)
          source: "frontend/dist/*" 
          target: "/opt/bitnami/apache/htdocs"
          # This removes 'frontend/dist/' from the path so files land in htdocs root
          strip_components: 2 

      - name: Restart Bitnami Apache
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Ensure permissions are correct for the bitnami user
            sudo chown -R bitnami:daemon /opt/bitnami/apache/htdocs
            sudo chmod -R 775 /opt/bitnami/apache/htdocs
            # Restart the service
            sudo /opt/bitnami/ctlscript.sh restart apache

      - name: Start Uvicorn Backend via Screen
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1. Kill the old backend session if it exists
            screen -S uvicorn-backend -X quit || true

            source main_venv/bin/activate

            # 2. Navigate to backend folder
            cd /home/bitnami/Intelligent-Browser-Agents/backend

            # 3. Start Uvicorn in a detached screen
            # -d -m starts it detached immediately
            # Use 'python3 -m uvicorn' to ensure it uses the correct path
            screen -d -m -S uvicorn-backend python3 -m uvicorn server:app --host 0.0.0.0 --port 8000
