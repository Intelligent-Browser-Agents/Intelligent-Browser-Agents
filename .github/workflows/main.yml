name: Deploy Web Server

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24' # Match your dev environment

      - name: Install and Build
        working-directory: ./frontend
        run: |
          npm install
          npm run build

      - name: Deploy to Bitnami via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # Path to your build output (e.g., frontend/dist or frontend/build)
          source: "frontend/dist/*" 
          target: "/opt/bitnami/apache/htdocs"
          # This removes 'frontend/dist/' from the path so files land in htdocs root
          strip_components: 2 

      - name: Restart Bitnami Apache
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Ensure permissions are correct for the bitnami user
            #sudo chown -R bitnami:daemon /opt/bitnami/apache/htdocs
            #sudo chmod -R 775 /opt/bitnami/apache/htdocs
            # Restart the service
            sudo /opt/bitnami/ctlscript.sh restart apache
